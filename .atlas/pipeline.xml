<atlas version="1">

  <meta>
    <name>atlas-pipeline</name>
    <default trigger="push"/>
    <requires>
      <!--<repo name="reponame" ref="master"/>-->
      <system>
        <apt name="nodejs"/>
        <apt name="npm"/>
        <apt name="jq"/>
      </system>      
    </requires>
  </meta>

  <triggers>
    <trigger name="push">
      <run task="validate"/>
      <run task="regression"/>
      <run task="codequality"/>
    </trigger>

    <trigger name="pr">
      <run task="validate"/>
      <run task="regression"/>
      <run task="codequality"/>
    </trigger>
  </triggers>

  <tasks>
    <task id="validate">
      <step id="validate" timeout="2m" cwd=".">
        <cmd>jq empty package.json</cmd>
        <cmd>jq empty language-configuration.json</cmd>
        <cmd>jq empty syntaxes/fracture.tmLanguage.json</cmd>
        <cmd>jq empty snippets/fracture.code-snippets</cmd>
        <cmd>jq empty .vscode/launch.json</cmd>
        <cmd>jq empty .vscode/extensions.json</cmd>
        <cmd>test -f examples/smoke.f</cmd>
        <cmd>test -f docs/QA_CHECKLIST.md</cmd>
        <cmd>test -f tests/grammar-regression.test.mjs</cmd>
      </step>
    </task>

    <task id="regression">
      <step id="regression" timeout="2m" cwd=".">
        <cmd>npm test</cmd>
      </step>
    </task>

    <task id="codequality">
      <step id="komply" timeout="5m" cwd=".">
        <cmd>komply</cmd>
      </step>
    </task>
  </tasks>
</atlas>
